<!DOCTYPE html>
<html lang="en" dir="auto">

<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="noindex, nofollow">
<title>Raw_test | Charlie&#39;s Blog</title>
<meta name="keywords" content="">
<meta name="description" content="
Source: https://raw.githubusercontent.com/chuckles201/DiT-Implementation/refs/heads/main/DDPM/sampler.py








    python
    import torch
from torch import nn as nn


&#39;&#39;&#39;DiT sampler
We are relying on the mathematical formulation of diffusion models
to train our model, and preform inference.

DDPM (training)
we will be sampling from random timesteps,
and predicting the ground-truth noise with 
MSE loss

&#39;&#39;&#39;
# DDPM w/ hybrid-loss 

class DDPM:
    def __init__(self,steps,betas,scale,loss2_weight=0.001,device=&#39;cpu&#39;):
        
        self.device=device
        
        self.loss2_weight = loss2_weight
        self.betas = torch.linspace(betas[0]**(1/scale),betas[1]**(1/scale),steps,device=device) ** scale
        self.alphas = 1-self.betas
        self.alphas_sqrt = torch.sqrt(self.alphas)
        
        self.alphas_cumprod = torch.cumprod(self.alphas,dim=0)
        self.betas_cumprod = 1 - self.alphas_cumprod
        
        # for quick-compute
        self.sqrt_alphas_cumprod = torch.sqrt(self.alphas_cumprod)
        self.sqrt_betas_cumprod = torch.sqrt(self.betas_cumprod)
        
        
        self.steps= steps
        
    def add_random_noise(self,batch):
        # for each batch, add-noise,
        # and return noisy image &#43; noise
        input_shape = batch.shape
        # easy to deal with
        batch = batch.view(input_shape[0],-1)
        noise = torch.randn_like(batch,device=self.device)
        # broadcast across dim=1
        steps = torch.randint(0,self.steps,size=(batch.shape[0],),device=self.device)
        
        # selecting from alpha bars
        # B, 1
        alpha_bars = self.alphas_cumprod[steps].view(-1,1)
        
        # adding according to noising process
        # std dev and mean
        noised_images = alpha_bars**0.5 * batch &#43; (1-alpha_bars)**0.5 * noise
        noised_images = noised_images.view(input_shape)
        
        # step doesn&#39;t matter; predicting
        # same ground-truth noise!
        noise = noise.view(input_shape)
        return noised_images,steps, noise
    
    def hybrid_loss(self,model_out,noise,t,noised_image):
        # getting both of our outputs
        # B, 2, c, h,w -&amp;gt; 2x, b,c,h,w
        # will need to use .view for shape-matching,
        # to broadcast for each b-dim
        pred_noise,pred_var = model_out.chunk(2,dim=1)
        pred_noise,pred_var = pred_noise.squeeze(1),pred_var.squeeze(1)
        
        # simple-loss
        l_simple = torch.mean((pred_noise-noise)**2)
        
        # calculating ground-truth mean and
        # predicted-mean (same but diff.-noise)
                
        pred_mean = (1/ self.alphas_sqrt[t].view(-1,1,1,1)) * \
            (noised_image-(self.betas[t].view(-1,1,1,1)/self.sqrt_betas_cumprod[t].view(-1,1,1,1))*pred_noise)
        real_mean = (1/ self.alphas_sqrt[t].view(-1,1,1,1)) * \
            (noised_image-(self.betas[t].view(-1,1,1,1)/self.sqrt_betas_cumprod[t].view(-1,1,1,1))*noise)
        
        # lower/upper bds of beta
        upper_beta = self.betas[t] # also &#39;ground-truth&#39;
        lower_beta = self.betas[t] * self.betas_cumprod[t-1] / self.betas_cumprod[t]
        pred_var = torch.exp(torch.log(upper_beta).view(-1,1,1,1)*pred_var &#43; torch.log(lower_beta).view(-1,1,1,1)*(1-pred_var))
        
        # full-loss,
        # should broadcast to B,shape_img,
        # stopgrad on mean, and average all of 
        # loss-parts together?
        dkl_loss = torch.mean((0.5 * (lower_beta.view(-1,1,1,1)/pred_var &#43; (((pred_mean-real_mean)**2).detach())/pred_var - 1 &#43; torch.log(pred_var/lower_beta.view(-1,1,1,1)))))
        hybrid_loss = dkl_loss*self.loss2_weight &#43; l_simple
        
        with torch.no_grad():
            self.loss_ratio = (dkl_loss*self.loss2_weight / l_simple)
        
        return hybrid_loss
    
    def hybrid_loss_ratio(self):
        return self.loss_ratio.item()
    




">
<meta name="author" content="">
<link rel="canonical" href="http://localhost:1313/posts/raw_test/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.6a415fa7fc28a3325d0b09df302c418b25489af6a1e14001cbcfc5c872331561.css" integrity="sha256-akFfp/woozJdCwnfMCxBiyVImvah4UABy8/FyHIzFWE=" rel="preload stylesheet" as="style">
<link rel="icon" href="http://localhost:1313/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="http://localhost:1313/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="http://localhost:1313/favicon-32x32.png">
<link rel="apple-touch-icon" href="http://localhost:1313/apple-touch-icon.png">
<link rel="mask-icon" href="http://localhost:1313/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="http://localhost:1313/posts/raw_test/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css" crossorigin="anonymous">
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js" crossorigin="anonymous"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js" crossorigin="anonymous"
onload="renderMathInElement(document.body);"></script>
<script>
document.addEventListener("DOMContentLoaded", function() {
    renderMathInElement(document.body, {
        delimiters: [
            {left: "$$", right: "$$", display: true},
            {left: "$", right: "$", display: false},
            {left: "\\(", right: "\\)", display: false},
            {left: "\\[", right: "\\]", display: true}
        ],
        throwOnError : false
    });
});
</script>





</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="http://localhost:1313/" accesskey="h" title="Charlie&#39;s Blog (Alt + H)">Charlie&#39;s Blog</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="http://localhost:1313/search/" title="Search üîç (Alt &#43; /)" accesskey=/>
                    <span>Search üîç</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/categories/" title="Categories üé®">
                    <span>Categories üé®</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/tags/" title="Tags üè∑Ô∏è">
                    <span>Tags üè∑Ô∏è</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/manifesto/" title="Manifesto üìú">
                    <span>Manifesto üìú</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <meta name="google" content="notranslate">
  <header class="post-header">
    
    <h1 class="post-title entry-hint-parent">
      Raw_test
    </h1>
    <div class="post-meta"><span title='2024-12-24 14:06:32 -0500 EST'>December 24, 2024</span>

</div>
  </header> 

  <div class="post-content"><blockquote>
<p>Source: <a href="https://raw.githubusercontent.com/chuckles201/DiT-Implementation/refs/heads/main/DDPM/sampler.py">https://raw.githubusercontent.com/chuckles201/DiT-Implementation/refs/heads/main/DDPM/sampler.py</a></p>
</blockquote>
<p>

<style>
  @keyframes textRainbow {
    0% { color: red; }
    16.7% { color: orange; }
    33.3% { color: yellow; }
    50% { color: green; }
    66.7% { color: rgb(0, 204, 255); }
    83.3% { color: rgb(0, 124, 130); }
    100% { color: violet; }
  }
  
    summary.test {
      animation: textRainbow 30s linear infinite;
      color: white;  
      padding: 10px;
      border-radius: 5px;  
      text-align: left;  
      cursor: pointer;  
      background: #131313;
      font-family: 'SF Mono', 'Cascadia Code', Menlo, monospace;
      font-size: medium;
    }

    .rain_container {
      margin: 0px;
    }


  </style>


<div class="rain_container">
<details open>
    <summary class="test">python</summary>
    <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> torch
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> torch <span style="color:#f92672">import</span> nn <span style="color:#66d9ef">as</span> nn
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#39;&#39;&#39;DiT sampler
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">We are relying on the mathematical formulation of diffusion models
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">to train our model, and preform inference.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">DDPM (training)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">we will be sampling from random timesteps,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">and predicting the ground-truth noise with 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">MSE loss
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&#39;&#39;&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># DDPM w/ hybrid-loss </span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">DDPM</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> __init__(self,steps,betas,scale,loss2_weight<span style="color:#f92672">=</span><span style="color:#ae81ff">0.001</span>,device<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;cpu&#39;</span>):
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>device<span style="color:#f92672">=</span>device
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>loss2_weight <span style="color:#f92672">=</span> loss2_weight
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>betas <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>linspace(betas[<span style="color:#ae81ff">0</span>]<span style="color:#f92672">**</span>(<span style="color:#ae81ff">1</span><span style="color:#f92672">/</span>scale),betas[<span style="color:#ae81ff">1</span>]<span style="color:#f92672">**</span>(<span style="color:#ae81ff">1</span><span style="color:#f92672">/</span>scale),steps,device<span style="color:#f92672">=</span>device) <span style="color:#f92672">**</span> scale
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>alphas <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span><span style="color:#f92672">-</span>self<span style="color:#f92672">.</span>betas
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>alphas_sqrt <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>sqrt(self<span style="color:#f92672">.</span>alphas)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>alphas_cumprod <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>cumprod(self<span style="color:#f92672">.</span>alphas,dim<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>betas_cumprod <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">-</span> self<span style="color:#f92672">.</span>alphas_cumprod
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># for quick-compute</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>sqrt_alphas_cumprod <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>sqrt(self<span style="color:#f92672">.</span>alphas_cumprod)
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>sqrt_betas_cumprod <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>sqrt(self<span style="color:#f92672">.</span>betas_cumprod)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>steps<span style="color:#f92672">=</span> steps
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">add_random_noise</span>(self,batch):
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># for each batch, add-noise,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># and return noisy image + noise</span>
</span></span><span style="display:flex;"><span>        input_shape <span style="color:#f92672">=</span> batch<span style="color:#f92672">.</span>shape
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># easy to deal with</span>
</span></span><span style="display:flex;"><span>        batch <span style="color:#f92672">=</span> batch<span style="color:#f92672">.</span>view(input_shape[<span style="color:#ae81ff">0</span>],<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>        noise <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>randn_like(batch,device<span style="color:#f92672">=</span>self<span style="color:#f92672">.</span>device)
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># broadcast across dim=1</span>
</span></span><span style="display:flex;"><span>        steps <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>randint(<span style="color:#ae81ff">0</span>,self<span style="color:#f92672">.</span>steps,size<span style="color:#f92672">=</span>(batch<span style="color:#f92672">.</span>shape[<span style="color:#ae81ff">0</span>],),device<span style="color:#f92672">=</span>self<span style="color:#f92672">.</span>device)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># selecting from alpha bars</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># B, 1</span>
</span></span><span style="display:flex;"><span>        alpha_bars <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>alphas_cumprod[steps]<span style="color:#f92672">.</span>view(<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># adding according to noising process</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># std dev and mean</span>
</span></span><span style="display:flex;"><span>        noised_images <span style="color:#f92672">=</span> alpha_bars<span style="color:#f92672">**</span><span style="color:#ae81ff">0.5</span> <span style="color:#f92672">*</span> batch <span style="color:#f92672">+</span> (<span style="color:#ae81ff">1</span><span style="color:#f92672">-</span>alpha_bars)<span style="color:#f92672">**</span><span style="color:#ae81ff">0.5</span> <span style="color:#f92672">*</span> noise
</span></span><span style="display:flex;"><span>        noised_images <span style="color:#f92672">=</span> noised_images<span style="color:#f92672">.</span>view(input_shape)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># step doesn&#39;t matter; predicting</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># same ground-truth noise!</span>
</span></span><span style="display:flex;"><span>        noise <span style="color:#f92672">=</span> noise<span style="color:#f92672">.</span>view(input_shape)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> noised_images,steps, noise
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">hybrid_loss</span>(self,model_out,noise,t,noised_image):
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># getting both of our outputs</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># B, 2, c, h,w -&amp;gt; 2x, b,c,h,w</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># will need to use .view for shape-matching,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># to broadcast for each b-dim</span>
</span></span><span style="display:flex;"><span>        pred_noise,pred_var <span style="color:#f92672">=</span> model_out<span style="color:#f92672">.</span>chunk(<span style="color:#ae81ff">2</span>,dim<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>        pred_noise,pred_var <span style="color:#f92672">=</span> pred_noise<span style="color:#f92672">.</span>squeeze(<span style="color:#ae81ff">1</span>),pred_var<span style="color:#f92672">.</span>squeeze(<span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># simple-loss</span>
</span></span><span style="display:flex;"><span>        l_simple <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>mean((pred_noise<span style="color:#f92672">-</span>noise)<span style="color:#f92672">**</span><span style="color:#ae81ff">2</span>)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># calculating ground-truth mean and</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># predicted-mean (same but diff.-noise)</span>
</span></span><span style="display:flex;"><span>                
</span></span><span style="display:flex;"><span>        pred_mean <span style="color:#f92672">=</span> (<span style="color:#ae81ff">1</span><span style="color:#f92672">/</span> self<span style="color:#f92672">.</span>alphas_sqrt[t]<span style="color:#f92672">.</span>view(<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">1</span>)) <span style="color:#f92672">*</span> \
</span></span><span style="display:flex;"><span>            (noised_image<span style="color:#f92672">-</span>(self<span style="color:#f92672">.</span>betas[t]<span style="color:#f92672">.</span>view(<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">1</span>)<span style="color:#f92672">/</span>self<span style="color:#f92672">.</span>sqrt_betas_cumprod[t]<span style="color:#f92672">.</span>view(<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">1</span>))<span style="color:#f92672">*</span>pred_noise)
</span></span><span style="display:flex;"><span>        real_mean <span style="color:#f92672">=</span> (<span style="color:#ae81ff">1</span><span style="color:#f92672">/</span> self<span style="color:#f92672">.</span>alphas_sqrt[t]<span style="color:#f92672">.</span>view(<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">1</span>)) <span style="color:#f92672">*</span> \
</span></span><span style="display:flex;"><span>            (noised_image<span style="color:#f92672">-</span>(self<span style="color:#f92672">.</span>betas[t]<span style="color:#f92672">.</span>view(<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">1</span>)<span style="color:#f92672">/</span>self<span style="color:#f92672">.</span>sqrt_betas_cumprod[t]<span style="color:#f92672">.</span>view(<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">1</span>))<span style="color:#f92672">*</span>noise)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># lower/upper bds of beta</span>
</span></span><span style="display:flex;"><span>        upper_beta <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>betas[t] <span style="color:#75715e"># also &#39;ground-truth&#39;</span>
</span></span><span style="display:flex;"><span>        lower_beta <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>betas[t] <span style="color:#f92672">*</span> self<span style="color:#f92672">.</span>betas_cumprod[t<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>] <span style="color:#f92672">/</span> self<span style="color:#f92672">.</span>betas_cumprod[t]
</span></span><span style="display:flex;"><span>        pred_var <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>exp(torch<span style="color:#f92672">.</span>log(upper_beta)<span style="color:#f92672">.</span>view(<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">1</span>)<span style="color:#f92672">*</span>pred_var <span style="color:#f92672">+</span> torch<span style="color:#f92672">.</span>log(lower_beta)<span style="color:#f92672">.</span>view(<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">1</span>)<span style="color:#f92672">*</span>(<span style="color:#ae81ff">1</span><span style="color:#f92672">-</span>pred_var))
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># full-loss,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># should broadcast to B,shape_img,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># stopgrad on mean, and average all of </span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># loss-parts together?</span>
</span></span><span style="display:flex;"><span>        dkl_loss <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>mean((<span style="color:#ae81ff">0.5</span> <span style="color:#f92672">*</span> (lower_beta<span style="color:#f92672">.</span>view(<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">1</span>)<span style="color:#f92672">/</span>pred_var <span style="color:#f92672">+</span> (((pred_mean<span style="color:#f92672">-</span>real_mean)<span style="color:#f92672">**</span><span style="color:#ae81ff">2</span>)<span style="color:#f92672">.</span>detach())<span style="color:#f92672">/</span>pred_var <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">+</span> torch<span style="color:#f92672">.</span>log(pred_var<span style="color:#f92672">/</span>lower_beta<span style="color:#f92672">.</span>view(<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">1</span>)))))
</span></span><span style="display:flex;"><span>        hybrid_loss <span style="color:#f92672">=</span> dkl_loss<span style="color:#f92672">*</span>self<span style="color:#f92672">.</span>loss2_weight <span style="color:#f92672">+</span> l_simple
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">with</span> torch<span style="color:#f92672">.</span>no_grad():
</span></span><span style="display:flex;"><span>            self<span style="color:#f92672">.</span>loss_ratio <span style="color:#f92672">=</span> (dkl_loss<span style="color:#f92672">*</span>self<span style="color:#f92672">.</span>loss2_weight <span style="color:#f92672">/</span> l_simple)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> hybrid_loss
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">hybrid_loss_ratio</span>(self):
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> self<span style="color:#f92672">.</span>loss_ratio<span style="color:#f92672">.</span>item()
</span></span><span style="display:flex;"><span>    
</span></span></code></pre></div>
</details>
</div>

</p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
    </ul>
  </footer><script src="https://utteranc.es/client.js"
        repo="chuckles201/chuckles201.github.io"
        issue-term="pathname"
        theme="preferred-color-scheme"
        crossorigin="anonymous"
        async>

        
</script>
  
</article>
    </main>
    
<footer class="footer">
        <span>&copy; 2024 <a href="http://localhost:1313/">Charlie&#39;s Blog</a></span> ¬∑ 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
